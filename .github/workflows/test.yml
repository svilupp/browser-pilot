name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run typecheck

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run unit tests
        run: bun test:unit

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: |
          which google-chrome || which chromium-browser || echo "Chrome not found in PATH"
          google-chrome --version || chromium-browser --version || echo "Could not get version"

      - name: Run integration tests
        run: bun test:integration
        env:
          CI: true
          # Increase timeout for CI environment
          TEST_TIMEOUT: 60000

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-failure-screenshots
          path: tests/screenshots/
          retention-days: 7
          if-no-files-found: ignore

  cli:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run CLI tests
        run: bun test:cli
        env:
          CI: true
          TEST_TIMEOUT: 60000

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cli-failure-screenshots
          path: tests/screenshots/
          retention-days: 7
          if-no-files-found: ignore

  # Summary job that depends on all test jobs
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [typecheck, unit, integration, cli]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.typecheck.result }}" == "failure" ] || \
             [ "${{ needs.unit.result }}" == "failure" ] || \
             [ "${{ needs.integration.result }}" == "failure" ] || \
             [ "${{ needs.cli.result }}" == "failure" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All tests passed!"
